```{r outnt, cache=cacheon}
survfunc <- function(time, event, eventname) {
  out <- data.frame(matrix(NA, ncol = 6, 3))

  out[1, 1] <- eventname
  colnames(out) <- c("Outcome", "Model", levels(rsdata$scream_ntprobnpstablepost))

  ## incidence rate
  out[1, 2] <- "No events, sum py, incidence rate/100py (95% CI)"

  ev <- rsdata %>%
    filter(!is.na(scream_ntprobnpstablepost)) %>%
    group_by(scream_ntprobnpstablepost) %>%
    summarise(
      ev = sum(!!sym(event) == "Yes"),
      .groups = "rowwise"
    )
  s <- rsdata %>%
    filter(!is.na(scream_ntprobnpstablepost)) %>%
    group_by(scream_ntprobnpstablepost) %>%
    summarise(
      s = sum(!!sym(time) / 365.25),
      .groups = "rowwise"
    )
  r <- pois.exact(x = ev$ev, pt = s$s / 100)

  out[1, 3:6] <- paste0(
    ev$ev, ", ",
    fn(s$s, dig = 0), ", ",
    fn(r$rate, dig = 1), " (",
    fn(r$lower, dig = 1), "-",
    fn(r$upper, dig = 1), ")"
  )

  # cox regressions
  ## crude
  out[2, 2] <- "Crude HR (95% CI), p-value"

  ## crude
  mod <- summary(coxph(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ scream_ntprobnpstablepost")),
    data = rsdata
  ))

  out[2, 3:6] <- c("ref", paste0(
    fn(mod$conf.int[1:3, 1], dig = 2),
    " (", fn(mod$conf.int[1:3, 3], dig = 2),
    "-", fn(mod$conf.int[1:3, 4], dig = 2), "), ",
    fn(mod$coef[1:3, 5], dig = 3, p = TRUE)
  ))

  ## adjusted covs
  out[3, 2] <- "Adjusted HR (95% CI), p-value"

  amod <- with(imprsdata, coxph(formula(paste0(
    "Surv(", time, ",", event, " == 'Yes') ~ scream_ntprobnpstablepost +",
    paste(modvars, collapse = " + ")
  ))))

  ## df the number of events minus the regression coefficients.
  ## There is support for this from middle of page 149 of the book by Parmer & Machin (ISBN 0471936405)
  asmod <- summary(pool(amod,
    dfcom =
      (amod$analyses[[1]]$nevent - length(amod$analyses[[1]]$coefficients))
  ))

  out[3, 3:6] <- c("ref", paste0(
    fn(exp(asmod$estimate[1:3]), dig = 2),
    " (", fn(exp(asmod$estimate[1:3] - global_z05 * asmod$std.error[1:3]), dig = 2),
    "-", fn(exp(asmod$estimate[1:3] + global_z05 * asmod$std.error[1:3]), dig = 2), "), ",
    fn(asmod$p.value[1:3], dig = 3, p = TRUE)
  ))

  return(out)
}

s1 <- survfunc(
  time = "sos_outtime_death1y",
  event = "sos_out_deathcv1y",
  eventname = "CV death (%) at 1 year"
)

s2 <- survfunc(
  time = "sos_outtime_death3y",
  event = "sos_out_deathcv3y",
  eventname = "CV death (%) at 3 years"
)

s3 <- survfunc(
  time = "sos_outtime_death1y",
  event = "sos_out_death1y",
  eventname = "All-cause death (%) at 1 year"
)

s4 <- survfunc(
  time = "sos_outtime_death3y",
  event = "sos_out_death3y",
  eventname = "All-cause death (%) at 3 years"
)


outall <- rbind(
  s1, s2, s3, s4
)

write.xlsx(outall, paste0("./output/tabs/out_", Sys.Date(), ".xlsx"), rowNames = FALSE, overwrite = TRUE)

default_kable(outall,
  font_size = 6,
  caption = "Association between change in NT-proBNP (index to post) and outcomes"
)
```
