```{r outnt, cache=cacheon}
survfunc <- function(data, impdata, changevar, time, event, eventname, noadjvar = NULL) {
  levs <- levels(data %>% pull(!!changevar))
  nlevs <- length(levs)
  out <- data.frame(matrix(NA, ncol = nlevs + 2, 3))

  out[1, 1] <- eventname
  colnames(out) <- c("Outcome", "Model", levs)

  ## incidence rate
  out[1, 2] <- "No events, sum py, incidence rate/100py (95% CI)"

  ev <- data %>%
    filter(!is.na(!!sym(changevar))) %>%
    group_by(!!sym(changevar), .drop = F) %>%
    summarise(
      ev = sum(!!sym(event) == "Yes"),
      .groups = "rowwise"
    )
  s <- data %>%
    filter(!is.na(!!sym(changevar))) %>%
    group_by(!!sym(changevar), .drop = F) %>%
    summarise(
      s = sum(!!sym(time) / 365.25, na.rm = T),
      .groups = "rowwise"
    )
  r <- pois.exact(x = ev$ev, pt = s$s / 100)

  out[1, 3:(nlevs + 2)] <- paste0(
    ev$ev, ", ",
    fn(s$s, dig = 0), ", ",
    fn(r$rate, dig = 1), " (",
    fn(r$lower, dig = 1), "-",
    fn(r$upper, dig = 1), ")"
  )

  # cox regressions
  ## crude
  out[2, 2] <- "Crude HR (95% CI), p-value"

  ## crude
  mod <- summary(coxph(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ ", changevar)),
    data = data
  ))

  out[2, 3:(nlevs + 2)] <- c("ref", paste0(
    fn(mod$conf.int[1:(nlevs - 1), 1], dig = 2),
    " (", fn(mod$conf.int[1:(nlevs - 1), 3], dig = 2),
    "-", fn(mod$conf.int[1:(nlevs - 1), 4], dig = 2), "), ",
    fn(mod$coef[1:(nlevs - 1), 5], dig = 3, p = TRUE)
  ))

  ## adjusted covs
  out[3, 2] <- "Adjusted HR (95% CI), p-value"

  if (is.null(noadjvar)) tmpmodvars <- modvars
  if (!is.null(noadjvar)) tmpmodvars <- modvars[!(modvars %in% noadjvar)]

  amod <- with(impdata, coxph(formula(paste0(
    "Surv(", time, ",", event, " == 'Yes') ~ ", changevar, " +",
    paste(tmpmodvars, collapse = " + ")
  ))))

  ## df the number of events minus the regression coefficients.
  ## There is support for this from middle of page 149 of the book by Parmer & Machin (ISBN 0471936405)
  asmod <- summary(pool(amod,
    dfcom =
      (amod$analyses[[1]]$nevent - length(amod$analyses[[1]]$coefficients))
  ))

  out[3, 3:(nlevs + 2)] <- c("ref", paste0(
    fn(exp(asmod$estimate[1:(nlevs - 1)]), dig = 2),
    " (", fn(exp(asmod$estimate[1:(nlevs - 1)] - global_z05 * asmod$std.error[1:(nlevs - 1)]), dig = 2),
    "-", fn(exp(asmod$estimate[1:(nlevs - 1)] + global_z05 * asmod$std.error[1:(nlevs - 1)]), dig = 2), "), ",
    fn(asmod$p.value[1:(nlevs - 1)], dig = 3, p = TRUE)
  ))

  return(out)
}

survfunc2 <- function(data2, impdata2, changevar2, noadjvar2 = NULL, tabname) {
  s1 <- survfunc(
    data = data2,
    changevar = changevar2,
    impdata = impdata2,
    time = "sos_outtime_death1y",
    event = "sos_out_deathcv1y",
    eventname = "CV death (%) at 1 year",
    noadjvar = noadjvar2
  )

  s2 <- survfunc(
    data = data2,
    impdata = impdata2,
    changevar = changevar2,
    time = "sos_outtime_death3y",
    event = "sos_out_deathcv3y",
    eventname = "CV death (%) at 3 years",
    noadjvar = noadjvar2
  )

  s3 <- survfunc(
    data = data2,
    impdata = impdata2,
    changevar = changevar2,
    time = "sos_outtime_death1y",
    event = "sos_out_death1y",
    eventname = "All-cause death (%) at 1 year",
    noadjvar = noadjvar2
  )

  s4 <- survfunc(
    data = data2,
    impdata = impdata2,
    changevar = changevar2,
    time = "sos_outtime_death3y",
    event = "sos_out_death3y",
    eventname = "All-cause death (%) at 3 years",
    noadjvar = noadjvar2
  )

  outall <- rbind(
    s1, s2, s3, s4
  )

  write.xlsx(outall, paste0("./output/tabs/Association between change in NT-proBNP (index to post) and outcomes - ", 
                            tabname, "_", Sys.Date(), ".xlsx"), rowNames = FALSE, overwrite = TRUE)

  default_kable(outall,
    font_size = 6,
    caption = paste0("Association between change in NT-proBNP (index to post) and outcomes - ", tabname)
  )
}

## Subsets of imputed data
imp_ref <- subset_datlist(imprsdata, subset = c(rsdata$shf_ef_cat == "HFrEF"))

imp_whfe <- subset_datlist(imprsdata, subset = c(rsdata$whfe == "WHFE" & !is.na(rsdata$whfe)))
imp_nwhfe <- subset_datlist(imprsdata, subset = c(rsdata$whfe == "WHFE" & !is.na(rsdata$whfe)))

imp_whferef <- subset_datlist(imprsdata, subset = c(rsdata$whfe == "WHFE" & !is.na(rsdata$whfe) & rsdata$shf_ef_cat == "HFrEF"))
imp_nwhferef <- subset_datlist(imprsdata, subset = c(rsdata$whfe == "WHFE" & !is.na(rsdata$whfe) & rsdata$shf_ef_cat == "HFrEF"))

# 4 groups

survfunc2(data2 = rsdata, impdata2 = imprsdata, changevar2 = "scream_ntprobnpstablepost", tabname = "Overall 4 change groups")

survfunc2(
  data2 = rsdata %>% filter(shf_ef_cat == "HFrEF"), impdata2 = imp_ref,
  changevar2 = "scream_ntprobnpstablepost", tabname = "HFrEF 4 change groups", noadjvar2 = "shf_ef_cat"
)

survfunc2(
  data2 = rsdata %>% filter(whfe == "WHFE"), impdata2 = imp_whfe,
  changevar2 = "scream_ntprobnpstablepost", tabname = "WHFE 4 change groups"
)
survfunc2(
  data2 = rsdata %>% filter(whfe == "NWHFE"), impdata2 = imp_nwhfe,
  changevar2 = "scream_ntprobnpstablepost", tabname = "NWHFE 4 change groups"
)


survfunc2(
  data2 = rsdata %>% filter(whfe == "WHFE" & shf_ef_cat == "HFrEF"), impdata2 = imp_whferef,
  changevar2 = "scream_ntprobnpstablepost", tabname = "WHFE HFrEF 4 change groups", noadjvar2 = "shf_ef_cat"
)
survfunc2(
  data2 = rsdata %>% filter(whfe == "NWHFE" & shf_ef_cat == "HFrEF"), impdata2 = imp_nwhferef,
  changevar2 = "scream_ntprobnpstablepost", tabname = "NWHFE HFrEF 4 change groups", noadjvar2 = "shf_ef_cat"
)

# 3 groups

survfunc2(data2 = rsdata, impdata2 = imprsdata, changevar2 = "scream_ntprobnpstablepost2", tabname = "Overall 3 change groups")

survfunc2(
  data2 = rsdata %>% filter(shf_ef_cat == "HFrEF"), impdata2 = imp_ref,
  changevar2 = "scream_ntprobnpstablepost2", tabname = "HFrEF 3 change groups", noadjvar2 = "shf_ef_cat"
)

survfunc2(
  data2 = rsdata %>% filter(whfe == "WHFE"), impdata2 = imp_whfe,
  changevar2 = "scream_ntprobnpstablepost2", tabname = "WHFE 3 change groups"
)
survfunc2(
  data2 = rsdata %>% filter(whfe == "NWHFE"), impdata2 = imp_nwhfe,
  changevar2 = "scream_ntprobnpstablepost2", tabname = "NWHFE 3 change groups"
)


survfunc2(
  data2 = rsdata %>% filter(whfe == "WHFE" & shf_ef_cat == "HFrEF"), impdata2 = imp_whferef,
  changevar2 = "scream_ntprobnpstablepost2", tabname = "WHFE HFrEF 3 change groups", noadjvar2 = "shf_ef_cat"
)
survfunc2(
  data2 = rsdata %>% filter(whfe == "NWHFE" & shf_ef_cat == "HFrEF"), impdata2 = imp_nwhferef,
  changevar2 = "scream_ntprobnpstablepost2", tabname = "NWHFE HFrEF 3 change groups", noadjvar2 = "shf_ef_cat"
)
```
