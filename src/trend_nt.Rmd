```{r trendnt, cache=cacheon, fig.cap="Trend over time of NT-proBNP testing", fig.width=8, fig.height=7}

tmplab <- left_join(rsdata %>% select(LopNr, shf_indexdtm),
  labnt,
  by = "LopNr"
) %>%
  mutate(
    tmptiment = as.numeric(labdtm - shf_indexdtm),
    labyear = year(labdtm),
    nt = 1
  ) %>%
  filter(tmptiment > 0) %>%
  group_by(LopNr, labyear) %>%
  slice(1) %>%
  ungroup() %>%
  select(LopNr, labyear, nt)

trendfunc <- function(year) {
  tmpyear <- left_join(rsdata,
    tmplab %>% filter(labyear == year),
    by = "LopNr"
  ) %>%
    filter(
      censdtm >= ymd(paste0(year, "1231")),
      shf_indexdtm <= ymd(paste0(year, "0101"))
    ) %>%
    mutate(nt = replace_na(nt, 0))

  tmpyear <- tmpyear %>%
    group_by(whfe) %>%
    count(nt) %>%
    mutate(
      per = n / sum(n) * 100,
      ntot = paste0(n, "/", sum(n)),
      year = year
    ) %>%
    ungroup() %>%
    filter(nt == 1)
}
trend <- trendfunc(2011)
trend <- rbind(trend, trendfunc(2012))
trend <- rbind(trend, trendfunc(2013))
trend <- rbind(trend, trendfunc(2014))
trend <- rbind(trend, trendfunc(2015))
trend <- rbind(trend, trendfunc(2016))
trend <- rbind(trend, trendfunc(2017))
trend <- rbind(trend, trendfunc(2018))


cexmy <- 1.2
# c(bottom, left, top, right) default c(5, 4, 4, 2) + 0.1.
par(mar = c(4, 4, .5, 2.5) + 0.1)

plot(trend$year[trend$whfe == "WHFE"], trend$per[trend$whfe == "WHFE"],
  type = "b",
  # type = "l",
  pch = 19,
  lty = 1,
  col = global_kicols[1],
  # lty = unique(riket$ltymy),
  lwd = 3,
  # cex = 1.5,
  axes = FALSE,
  xaxs = "i",
  yaxs = "i",
  ylim = c(40, 60),
  xlim = c(2012 - 0.5, 2018 + 0.5),
  ylab = "Percent",
  xlab = "Calender year",
  cex.lab = cexmy
)

matplot(trend$year[trend$whfe == "NWHFE"],
  trend$per[trend$whfe == "NWHFE"],
  type = "b",
  # type = "l",
  pch = 19,
  lty = 2,
  col = global_kicols[2],
  lwd = 3,
  add = T
)

box(bty = "l")
axis(1, cex.axis = cexmy)
axis(2, seq(40, 60, 5), las = 2, cex.axis = cexmy)

mtext(
  side = 4,
  line = -1,
  at = c(trend %>% filter(year == 2018) %>% pull(per)),
  levels(rsdata %>% pull(whfe)),
  las = 1,
  cex = cexmy,
)

text(trend$year[trend$whfe == "WHFE"], trend$per[trend$whfe == "WHFE"] + 1.5, trend$ntot[trend$whfe == "WHFE"], cex = cexmy)
text(trend$year[trend$whfe == "NWHFE"], trend$per[trend$whfe == "NWHFE"] - 1.5, trend$ntot[trend$whfe == "NWHFE"], cex = cexmy)
```
