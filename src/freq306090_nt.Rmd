```{r freq306090nt, cache=cacheon}

tmplab <- left_join(
  rsdata %>% select(LopNr, shf_indexdtm),
  labnt,
  by = "LopNr"
) %>%
  mutate(
    tmptiment = as.numeric(labdtm - shf_indexdtm),
    nt = 1
  ) %>%
  filter(tmptiment >= -90 & tmptiment <= 90)

trendfunc <- function(timestart, timestop, timename, data) {
  tmplab2 <- tmplab %>%
    filter(tmptiment >= timestart & tmptiment <= timestop) %>%
    group_by(LopNr) %>%
    slice(1) %>%
    ungroup() %>%
    select(LopNr, nt)

  tmplab2 <- left_join(data,
    tmplab2,
    by = "LopNr"
  ) %>%
    filter(
      sos_outtime_death >= timestop
    ) %>%
    mutate(nt = replace_na(nt, 0))

  tmplab2_all <- tmplab2 %>%
    count(nt) %>%
    mutate(
      per = paste0(fn(n / sum(n) * 100, 1), "%"),
      ntot = paste0(n, "/", sum(n), " (", per, ")"),
      "Time point" = timename,
      whfe = "Overall"
    ) %>%
    filter(nt == 1)

  tmplab2_whfe <- tmplab2 %>%
    group_by(whfe) %>%
    count(nt) %>%
    mutate(
      per = paste0(fn(n / sum(n) * 100, 1), "%"),
      ntot = paste0(n, "/", sum(n), " (", per, ")"),
      "Time point" = timename
    ) %>%
    ungroup() %>%
    filter(nt == 1)

  out <- bind_rows(tmplab2_all, tmplab2_whfe)
}

trendfunc2 <- function(data2, popname) {
  trend <- trendfunc(timestart = -90, timestop = -1, timename = "90-1 days prior to index", data = data2)
  trend <- rbind(trend, trendfunc(-60, -1, "60-1 days prior to index", data2))
  trend <- rbind(trend, trendfunc(-30, -1, "30-1 days prior to index", data2))
  trend <- rbind(trend, trendfunc(-14, -1, "14-1 days prior to index", data2))
  trend <- rbind(trend, trendfunc(0, 14, "0-14 days post index", data2))
  trend <- rbind(trend, trendfunc(0, 30, "0-30 days post index", data2))
  trend <- rbind(trend, trendfunc(0, 60, "0-60 days post index", data2))
  trend <- rbind(trend, trendfunc(0, 90, "0-90 days post index", data2))

  trend <- trend %>%
    select(whfe, `Time point`, ntot) %>%
    pivot_wider(names_from = whfe, values_from = ntot)

  write.xlsx(trend,
    paste0(
      "./output/tabs/NT-proBNP testing within 14, 30, 60 and 90 days before and after the index date - ",
      popname, "_", Sys.Date(), ".xlsx"
    ),
    rowNames = FALSE, overwrite = TRUE
  )

  default_kable(trend,
    scale_down = F,
    caption = paste0("NT-proBNP testing within 14, 30, 60 and 90 days before and after the index date - ", popname),
    escape = TRUE
  )
}

trendfunc2(data2 = rsdata, "Overall")
trendfunc2(rsdata %>% filter(shf_ef_cat == "HFrEF"), "HFrEF")
```
